name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly

    - name: Install dependencies
      run: |
        cd contracts
        forge install

    - name: Run tests
      run: |
        cd contracts
        forge test -vvv

    - name: Check formatting
      run: |
        cd contracts
        forge fmt --check

  contract-coverage:
    name: Contract Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly

    - name: Install dependencies
      run: |
        cd contracts
        forge install

    - name: Run coverage
      run: |
        cd contracts
        forge coverage --report summary

  gas-snapshot:
    name: Gas Snapshot
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly

    - name: Install dependencies
      run: |
        cd contracts
        forge install

    - name: Generate gas snapshot
      run: |
        cd contracts
        forge snapshot

    - name: Upload gas snapshot
      uses: actions/upload-artifact@v4
      with:
        name: gas-snapshot
        path: contracts/.gas-snapshot

  sdk-tests:
    name: SDK Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build SDK
      run: cd sdk && npm run build

    - name: Run tests
      run: cd sdk && npm test

    - name: Type check
      run: cd sdk && npm run typecheck

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint
