name: Deploy Contracts

on:
  push:
    branches: [ main ]
    paths:
      - 'contracts/**'
  workflow_dispatch:

jobs:
  deploy-testnet:
    name: Deploy to Base Sepolia
    runs-on: ubuntu-latest
    environment: testnet
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly
    
    - name: Install dependencies
      run: |
        cd contracts
        forge install
    
    - name: Deploy contracts
      run: |
        cd contracts
        forge script script/Deploy.s.sol \
          --rpc-url ${{ secrets.BASE_SEPOLIA_RPC }} \
          --private-key ${{ secrets.DEPLOYER_PRIVATE_KEY }} \
          --broadcast \
          --verify \
          -vvvv
      env:
        BASESCAN_API_KEY: ${{ secrets.BASESCAN_API_KEY }}
    
    - name: Upload deployment artifacts
      uses: actions/upload-artifact@v4
      with:
        name: contract-addresses
        path: contracts/broadcast/
